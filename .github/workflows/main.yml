name: Ultra OBS RDP (Auto-Generated Credentials)
on:
  workflow_dispatch:

jobs:
  stream-ready-rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
      - name: ðŸš€ Optimize System & Install Essentials
        run: |
          Write-Host "Disabling Sleep Modes..."
          powercfg -change -standby-timeout-ac 0
          powercfg -change -monitor-timeout-ac 0
          
          Write-Host "Installing Chocolatey Packages (OBS, Chrome, VB-Cable)..."
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          
          choco install obs-studio -y --no-progress --ignore-checksums
          choco install googlechrome -y --no-progress --ignore-checksums
          choco install vb-cable -y --no-progress --ignore-checksums

      - name: ðŸ›¡ï¸ Configure Firewall & RDP (From Working Reference)
        run: |
          # These settings match your working "RDP" repo exactly
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          # SecurityLayer 0 fixes many connection errors
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Firewall Rules
          netsh advfirewall firewall delete rule name="RDP-Tailscale" all
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="OBS-Stream" dir=in action=allow protocol=TCP localport=1935
          
          Restart-Service -Name TermService -Force
          Write-Host "RDP and Firewall Configured Successfully."

      - name: ðŸ‘¤ Auto-Generate User & Grant Permissions
        run: |
          # 1. GENERATE RANDOM CREDENTIALS
          $autoUser = "StreamUser"
          # Generates a random 12-character password with letters and numbers + a symbol to satisfy complexity requirements
          $randomPass = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_}) + "!"
          
          Write-Host "Generated Username: $autoUser"
          # We save these to Environment Variables so we can print them at the end
          echo "GEN_USER=$autoUser" >> $env:GITHUB_ENV
          echo "GEN_PASS=$randomPass" >> $env:GITHUB_ENV

          $securePass = ConvertTo-SecureString $randomPass -AsPlainText -Force

          # 2. CREATE USER (Using your working logic: Check if exists first)
          if (-not (Get-LocalUser -Name $autoUser -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $autoUser -Password $securePass -AccountNeverExpires -Description "Auto Generated RDP User"
              Write-Host "User created successfully."
          } else {
              Write-Host "User already exists, updating password."
              Set-LocalUser -Name $autoUser -Password $securePass
          }

          # 3. ADD TO GROUPS
          Add-LocalGroupMember -Group "Administrators" -Member $autoUser
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $autoUser
          
          # Verify
          if (-not (Get-LocalUser -Name $autoUser)) {
              Write-Error "User creation failed!"
              exit 1
          }
          Write-Host "User setup complete."

      - name: ðŸŒ Install & Connect Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi"
          $installerPath = "$env:TEMP\tailscale.msi"

          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force
          
          # Connect
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="OBS-Stream-$env:GITHUB_RUN_ID" --accept-routes
          
          # Get IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 20) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 3
              $retries++
          }
          
          if (-not $tsIP) { 
            Write-Error "Failed to get Tailscale IP" 
            exit 1 
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: ðŸŸ¢ SUCCESS - Credentials
        run: |
          Write-Host " "
          Write-Host "=============================================" -ForegroundColor Green
          Write-Host "   STREAMING RDP IS READY TO CONNECT" -ForegroundColor Green
          Write-Host "=============================================" -ForegroundColor Green
          Write-Host "   IP Address:  $env:TAILSCALE_IP" -ForegroundColor Cyan
          Write-Host "   Username:    $env:GEN_USER" -ForegroundColor Yellow
          Write-Host "   Password:    $env:GEN_PASS" -ForegroundColor Yellow
          Write-Host "============================================="
          Write-Host "   Copy these credentials to connect!"
          
          # Loop forever to keep instance alive
          while ($true) {
            Start-Sleep -Seconds 60
          }
